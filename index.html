<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weihnachtsmarkt Earnings Calculator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Jost:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loading-overlay">
    </div>

    <main id="app-layout">

        <div id="left-column">
            
            <h1 id="header-title"><span>Part-Time <br>Job Calculator</span></h1>

            <div class="settings-area">
                <div id="job-detail-div">
                        <h3>1. Job Details</h3>
                    <label>
                        Hourly Wage (â‚¬):
                        <input type="number" id="hourly-rate" value="13">
                    </label>
                    <label>
                        Hours per Shift: 
                        <input type="number" id="shift-hours" value="4">
                    </label>
                </div>

                <div id="market-duration-div">
                    <h3>2. Market Duration</h3>
                    <label>
                        Start Date:
                        <input type="date" id="start-date" value="2025-11-29">
                    </label>
                    <label>
                        End Date:
                        <input type="date" id="end-date" value="2025-12-28">
                    </label>
                </div>
                

                <button id="generate-weeks-btn">Generate Schedule</button>
            </div>
        </div>    

        <div id="schedule-area" style="display:none;">
            <h3>3. Select Working Days</h3>
            <p>Check the boxes for the days you will work.</p>
            
            <div class="weeks-container" id="weeks-container">
                <!-- Weeks and Days will be generated here -->
            </div>

            <br>
        </div>
    </main>

    <footer>
        <div id="result-area">
            <h3>Total Earnings: <span id="total-display">0.00 â‚¬</span></h3>
            <p>Total Hours: <span id="hours-display">0</span></p>
            <button class="clear-data-btn" id="clear-data-btn-desktop"></button>
        </div>
    </footer>



    <span><button class="clear-data-btn" id="clear-data-btn-mobile"></button></span>

    <script>
        /* =========================================
        1. SETUP & DOM ELEMENTS
        ========================================= */
        
        // Buttons
        const generateBtn = document.getElementById('generate-weeks-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        
        // Containers
        const weeksContainer = document.getElementById('weeks-container');
        const scheduleArea = document.getElementById('schedule-area');

        // Inputs
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const hourlyRateInput = document.getElementById('hourly-rate');
        const shiftHoursInput = document.getElementById('shift-hours');

        // Output Text
        const totalDisplay = document.getElementById('total-display');
        const hoursDisplay = document.getElementById('hours-display');

        // Clear Data Button
        const clearDataBtn = document.querySelectorAll('.clear-data-btn');


        /* =========================================
        2. HELPER FUNCTIONS
        ========================================= */

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                weekday: 'short', month: 'short', day: 'numeric' 
            });
        }


        /* =========================================
        3. MAIN LOGIC: GENERATE SCHEDULE
        ========================================= */

        generateBtn.addEventListener('click', () => {
            const IsScheduleShown = scheduleArea.classList.contains('show');

            if(IsScheduleShown == false){
                document.getElementById('left-column').classList.add('pressed');
            }
            generateFunction();
            saveData(); // Save immediately when user changes schedule
        });

        function generateFunction(firstLoading = false) {
            // Get Inputs
            const start = startDateInput.valueAsDate;
            const end = endDateInput.valueAsDate;
            const defaultHours = shiftHoursInput.value; 

            // Validation
            if (!start || !end || start > end) {
                // Check if we are just loading (start might be null initially)
                if(startDateInput.value === "") return; 
                alert("Please check your dates!");
                return;
            }

            // --- BACKPACK STRATEGY (Save State) ---
            const currentRows = document.querySelectorAll('.day-row');
            let rowBackpack = {};

            currentRows.forEach(row => {
                const id = row.getAttribute('data-date'); 
                if (id) rowBackpack[id] = row;         
            });
            // --------------------------------------

            // Clear visual container
            weeksContainer.innerHTML = ''; 

            // Loop setup
            let currentDate = new Date(start);
            let weekCount = 1;

            // Create first week box
            let currentWeekDiv = document.createElement('div');
            currentWeekDiv.className = 'week-box'; 
            currentWeekDiv.innerHTML = `
            <div id="WeekText">
                    <h4>Week ${weekCount}</h4>
                    <h4>Hours</h4>
                </div>`;
            weeksContainer.appendChild(currentWeekDiv);

            // Generate Days
            while (currentDate <= end) {
                const dateKey = currentDate.toISOString().slice(0,10);
                let dayContainer;

                if(rowBackpack[dateKey]){
                    // RECYCLE OLD ROW â™»ï¸
                    dayContainer = rowBackpack[dateKey];
                    
                    // Logic: If unchecked, update to new default hours. 
                    // If checked, keep user's custom hours.
                    const checkbox = dayContainer.querySelector('.day-checkbox');
                    const input = dayContainer.querySelector('.day-hours-input');
                    if (checkbox.checked === false) {
                        input.value = defaultHours;
                    }

                } else {
                    // CREATE NEW ROW ðŸ”¨
                    dayContainer = document.createElement('div');
                    dayContainer.className = 'day-row';
                    dayContainer.setAttribute('data-date', dateKey);

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'day-checkbox';
                    checkbox.addEventListener('change', () => {
                        CalculateFunction() // Recalculate on change
                    });
                    
                    const label = document.createElement('label');
                    label.innerHTML = "&nbsp;" + formatDate(currentDate);
                    label.style.flexGrow = "1"; 
                    label.prepend(checkbox);

                    const hourInput = document.createElement('input');
                    hourInput.type = 'float';
                    hourInput.className = 'day-hours-input'; 
                    hourInput.value = defaultHours;
                    hourInput.addEventListener('input', () => {
                        if(hourInput.value < 0) hourInput.value = 0;
                        if(hourInput.value > 24) hourInput.value = 24;
                        CalculateFunction() // Recalculate on input
                    });

                    dayContainer.appendChild(label);
                    dayContainer.appendChild(hourInput);
                }
                
                currentWeekDiv.appendChild(dayContainer);

                // Handle Sunday Break
                if (currentDate.getDay() === 0 && currentDate < end) {
                    weekCount++;
                    currentWeekDiv = document.createElement('div');
                    currentWeekDiv.className = 'week-box';
                    currentWeekDiv.style.marginTop = "20px"; 
                    currentWeekDiv.innerHTML = `<h4>Week ${weekCount}</h4>`;
                    weeksContainer.appendChild(currentWeekDiv);
                }

                currentDate = addDays(currentDate, 1);
            }

            // Show result
            scheduleArea.style.display = 'block';
            scheduleArea.classList.add('show');

            if(firstLoading == false){
                weeksContainer.scrollIntoView({ behavior: 'smooth'});
                
            }


        }


        /* =========================================
        4. CALCULATION LOGIC
        ========================================= */
        
        function CalculateFunction() {
            const checkedBoxes = document.querySelectorAll('.day-checkbox:checked');
            let totalHours = 0;

            checkedBoxes.forEach(function(box) {
                const rowContainer = box.closest('.day-row');
                const hourInput = rowContainer.querySelector('.day-hours-input');
                const hoursForThisDay = parseFloat(hourInput.value);
                
                if (!isNaN(hoursForThisDay) && hoursForThisDay > 0 && hoursForThisDay <= 24) {
                    totalHours += hoursForThisDay;
                }
            });

            const wage = parseFloat(hourlyRateInput.value) || 0;
            const totalMoney = totalHours * wage;

            hoursDisplay.textContent = totalHours;

            const formatter = new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2
            });
            
            totalDisplay.textContent = formatter.format(totalMoney);

            saveData(); // Save after calculating

        };


        /* =========================================
        5. SAVE & LOAD (DATA PERSISTENCE)
        ========================================= */

        function saveData() {
            // We keep YOUR variable names here to ensure compatibility
            const Settings = {
                hourlyRateInput: hourlyRateInput.value,
                shiftHoursInput: shiftHoursInput.value,
                startDateInput: startDateInput.value,
                endDateInput: endDateInput.value
            };

            const shifts = {};
            const dayRows = document.querySelectorAll('.day-row');
            
            dayRows.forEach(row => {
                const checkbox = row.querySelector('.day-checkbox');
                const hourInput = row.querySelector('.day-hours-input');
                const dateLabel = row.querySelector('label').innerText.trim();
                
                if (checkbox.checked || hourInput.value !== shiftHoursInput.value) {
                    shifts[dateLabel] = {
                        checked: checkbox.checked,
                        hours: hourInput.value
                    };
                }
            });

            localStorage.setItem('marketSettings', JSON.stringify(Settings));
            localStorage.setItem('marketShifts', JSON.stringify(shifts));
        }

        function loadData() {
            const savedSettings = localStorage.getItem('marketSettings');
            const savedShifts = localStorage.getItem('marketShifts');

            if (savedSettings) {
                const Settings = JSON.parse(savedSettings);
                // Re-applying your exact keys
                hourlyRateInput.value = Settings.hourlyRateInput;
                shiftHoursInput.value = Settings.shiftHoursInput;
                startDateInput.value = Settings.startDateInput;
                endDateInput.value = Settings.endDateInput;
            }

            if(savedShifts) {
                const Shifts = JSON.parse(savedShifts);
                
                // Build the HTML first
                generateFunction(true); 

                // Fill in the details
                const elements = document.querySelectorAll('.day-row');
                elements.forEach(row => {
                    const dateLabel = row.querySelector('label').innerText.trim();
                    if(Shifts[dateLabel]) {
                        row.querySelector('.day-checkbox').checked = Shifts[dateLabel].checked;
                        row.querySelector('.day-hours-input').value = Shifts[dateLabel].hours;
                    }
                });
                
                // Update the totals text
                CalculateFunction();
            }
        }

        // Initialize
        // Using your method with () to ensure it runs immediately if DOM is ready
        window.addEventListener('DOMContentLoaded', loadData());
        // Wait for EVERYTHING (images, fonts, css) to load
        window.addEventListener('load', () => {
            document.body.classList.add('loaded');
        });
        
        clearDataBtn.forEach(button => {
            let TextInitial = "Clear Data";
            button.textContent = TextInitial;
            let Confirm = false;
            button.style.padding = "4px 8px";

            button.addEventListener('click', () => {
                if (Confirm == true) {
                    localStorage.removeItem('marketShifts');
                    location.reload(); // Reload to reset the app
                }else if(Confirm == false){
                    button.textContent = "Are you sure?";
                    Confirm = true;
                    button.style.padding = "8px 16px";

                    setTimeout(() => {
                        Confirm = false;
                        button.textContent = TextInitial;
                        
                        button.style.padding = "4px 8px";

                    }, 1500);
                }
            });
        });


    </script>
</body>
</html>
